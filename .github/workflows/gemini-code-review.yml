# .github/workflows/ai-code-review.yml (v4 - Fix script injection issue)

name: AI Code Review with Gemini

on:
  pull_request:
    # ç›£è½ PR çš„é–‹å•Ÿã€æ›´æ–°ç‹€æ…‹
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    #æŒ‡å®šé€™å€‹å·¥ä½œå°‡åœ¨ GitHub æä¾›çš„æœ€æ–°ç‰ˆ Ubuntu Linux è™›æ“¬ç’°å¢ƒ(runner)ä¸ŠåŸ·è¡Œ
    runs-on: ubuntu-latest

    steps:
      # Step 1: å®‰è£ jq å·¥å…·(jq æ˜¯ä¸€å€‹å‘½ä»¤åˆ—çš„ JSON è™•ç†å™¨)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Step 2: å°‡å„²å­˜åº«çš„ç¨‹å¼ç¢¼ä¸‹è¼‰åˆ° runner ç’°å¢ƒä¸­
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 3: æ¯”è¼ƒ Pull Request ä¸­çš„ç¨‹å¼ç¢¼å·®ç•°ï¼Œä¸¦è¨­å®šä¸€å€‹ flag ä¾†åˆ¤æ–·æ˜¯å¦æœ‰å·®ç•°
      - name: Get PR Diff
        id: get_diff
        run: |
          git diff --no-color "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" > diff.txt
          
          if [ ! -s diff.txt ]; then
            echo "No code changes detected. Skipping AI review."
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "Code changes detected. Proceeding with AI review."
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      # Step 4: å‘¼å« Gemini API ä¾†åš Code Review
      - name: Call Gemini API for Code Review
        id: call_gemini
        if: steps.get_diff.outputs.continue == 'true'
        run: |
          CODE_DIFF=$(cat diff.txt)
          JSON_PAYLOAD=$(jq -n --arg diff "$CODE_DIFF" '{
            "contents": [{
              "parts": [{
                "text": "ä½ æ˜¯ä¸€ä½è³‡æ·±ç¨‹å¼ç¢¼å¯©æŸ¥å“¡ï¼Œå°ˆé•·åœ¨æ–¼æ‰¾å‡ºæŠ€è¡“å‚µã€é‡æ§‹å»ºè­°èˆ‡ clean code å’Œ SOLID åŸå‰‡ã€‚\n\nä»¥ä¸‹æ˜¯ pull request çš„ç¨‹å¼ç¢¼å·®ç•°ï¼Œè«‹æŒ‡å‡ºæ˜¯å¦æœ‰æŠ€è¡“å‚µã€å£å‘³é“ã€ç¶­è­·é¢¨éšªã€å®‰å…¨æ€§å•é¡Œï¼Œä¸¦çµ¦å‡ºé‡æ§‹å»ºè­°ã€‚\n\n è«‹åœ¨é …ç›®ç¬¦è™Ÿæ¸…å–®ä¸­æä¾›å…·é«”ã€å¯æ“ä½œçš„é‡æ§‹å»ºè­°ã€‚\n\nèªè¨€è«‹ä»¥ç¹é«”ä¸­æ–‡æ’°å¯«ã€‚\n\n---START CODE DIFF---\n\n\($diff)\n\n---END CODE DIFF---"
              }]
            }],
            "generationConfig": { "temperature": 0.4, "topK": 32, "topP": 1, "maxOutputTokens": 4096, "stopSequences": [] },
            "safetySettings": [
              { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
              { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }
            ]
          }')
          API_KEY="${{ secrets.GEMINI_API_KEY }}"
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-001:generateContent?key=${API_KEY}" -H "Content-Type: application/json" -d "${JSON_PAYLOAD}")
          if echo "${RESPONSE}" | jq -e '.error' > /dev/null; then echo "::error::Gemini API returned an error:" && echo "${RESPONSE}" && exit 1; fi
          if ! echo "${RESPONSE}" | jq -e '.candidates' > /dev/null; then echo "::error::Gemini API response is not in the expected format. 'candidates' field is missing." && echo "Full response: ${RESPONSE}" && exit 1; fi
          REVIEW_COMMENT=$(echo "${RESPONSE}" | jq -r '.candidates[0].content.parts[0].text')
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "${REVIEW_COMMENT}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Step 5: å°‡ AI è©•è«–ç™¼ä½ˆåˆ° Pull è«‹æ±‚
      - name: Post Review Comment to PR
        if: steps.get_diff.outputs.continue == 'true'
        uses: actions/github-script@v7
        env:
          REVIEW_COMMENT: ${{ steps.call_gemini.outputs.review_comment }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawComment = process.env.REVIEW_COMMENT;
            // åœ¨æ’å…¥åˆ°æ¨£æ¿å­—é¢å€¼ä¹‹å‰ï¼Œå°æ‰€æœ‰åå¼•è™Ÿé€²è¡Œè·³è„«
            const escapedComment = rawComment.replace(/`/g, '\\`');
            
            const issue_number = context.issue.number;
  
            const finalBody = `
            ### ğŸ¤– Gemini AI Code Review
  
            æ‚¨å¥½ï¼æˆ‘å·²ç¶“å¯©æ ¸äº†æ­¤PRè«‹æ±‚ä¸­çš„è®Šæ›´ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„ç™¼ç¾:
  
            ---
  
            ${escapedComment}
  
            ---
  
            *Note: This is an automated review by Gemini. Please use it as a guide and apply human oversight.*
            `;
  
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: finalBody
            });
