# .github/workflows/pr-lifecycle.yml
name: PR Lifecycle CI/CD

on:
  pull_request:
    types: [opened, synchronize, closed]
    # ç›£è½ PR çš„é–‹å•Ÿã€æ›´æ–°ã€é—œé–‰ç‹€æ…‹
    branches:
      - main # æˆ–æ‚¨çš„ä¸»è¦åˆ†æ”¯

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: CI - å»ºç½®èˆ‡æ¸¬è©¦ (.NET Framework 4.8 ç‰ˆæœ¬)
  build-and-test:
    # åªåœ¨ PR é–‹å•Ÿæˆ–æ›´æ–°æ™‚åŸ·è¡Œ
    #if: github.event.action == 'opened' || github.event.action == 'synchronize'
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    # 1. æ›´æ›ç‚º Windows é‹è¡Œç’°å¢ƒ
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. è¨­å®š MSBuild (ç”¨æ–¼å»ºç½® .NET Framework å°ˆæ¡ˆ)
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 3. è¨­å®š NuGet (ç”¨æ–¼é‚„åŸå¥—ä»¶)
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
     
    # 4. ä½¿ç”¨ NuGet é‚„åŸå°ˆæ¡ˆå¥—ä»¶     
    - name: Restore Dependencies
      run: nuget restore CopilotAgentCodeReviewTest/CopilotAgentCodeReviewTest.sln

    # 5. ä½¿ç”¨ MSBuild å»ºç½®è§£æ±ºæ–¹æ¡ˆ
    - name: Build Solution
      run: msbuild CopilotAgentCodeReviewTest/CopilotAgentCodeReviewTest.sln /p:Configuration=Release

    # --- å¾…è¾¦äº‹é …ï¼šå–®å…ƒæ¸¬è©¦ ---
    # ä»¥ä¸‹æ­¥é©Ÿå·²æš«æ™‚è¨»è§£ã€‚
    # åŸå› ï¼šç›®å‰çš„å°ˆæ¡ˆçµæ§‹ä¸­æ²’æœ‰å–®å…ƒæ¸¬è©¦å°ˆæ¡ˆã€‚
    # å¦‚ä½•å•Ÿç”¨ï¼š
    # 1. åœ¨æ‚¨çš„è§£æ±ºæ–¹æ¡ˆä¸­æ–°å¢ä¸€å€‹æ¸¬è©¦å°ˆæ¡ˆ (ä¾‹å¦‚ CopilotAgentCodeReviewTest.Tests)ã€‚
    # 2. å°‡æ–°çš„æ¸¬è©¦å°ˆæ¡ˆæ¨é€åˆ°å„²å­˜åº«ã€‚
    # 3. å–æ¶ˆä»¥ä¸‹æ­¥é©Ÿçš„è¨»è§£ã€‚
    # - name: Run Unit Tests
    #   uses: microsoft/vstest-action@v1
    #   with:
    #     testFiles: '${{ github.workspace }}\**\bin\Release\*Tests.dll'
    #     platform: 'x64'
    #     configuration: 'Release'
    
  # Job 2: CD - æ¨¡æ“¬éƒ¨ç½²åˆ°é å‚™ç’°å¢ƒ (Staging)
  deploy-to-staging:
    #if: github.event.action == 'opened' || github.event.action == 'synchronize'
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    # è¨­å®šä¾è³´é—œä¿‚ï¼šå¿…é ˆç­‰å¾… build-and-test å’Œ ai-code-review æˆåŠŸå¾Œæ‰èƒ½åŸ·è¡Œ
    needs: [build-and-test]
    steps:
      - name: Simulate Deployment to Staging
        run: |
          echo "âœ… Build and test passed!"
          echo "ğŸš€ Simulating deployment of PR #${{ github.event.pull_request.number }} to Staging environment..."
          sleep 5 # æ¨¡æ“¬éƒ¨ç½²éç¨‹
          echo "ğŸ‰ Staging deployment successful!"
      
      - name: Post Staging URL to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const stagingUrl = `http://staging.example.com/pr-${prNumber}`; // æ¨¡æ“¬çš„ Staging URL
            const body = `âœ… **Deployment to Staging successful!**\n\nYou can preview the changes here: [${stagingUrl}](${stagingUrl})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # Job 3: PR åˆä½µå¾Œçš„å‹•ä½œ (éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ)
  post-merge-actions:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: [deploy-to-staging]
    # æ³¨æ„ï¼šé€™å€‹ Job æ‡‰è©²ä¾è³´ CI/CD çš„æˆåŠŸï¼Œä½†åœ¨å¯¦å‹™ä¸Šé€šå¸¸é€éåˆ†æ”¯ä¿è­·è¦å‰‡ä¾†ç¢ºä¿
    steps:
      - name: Display Merge Confirmation Message
        run: |
          echo "ğŸ‰ æ­å–œï¼é€™å€‹ Pull Request å·²ç¶“æˆåŠŸåˆä½µåˆ° ${{ github.event.pull_request.base.ref }} åˆ†æ”¯äº†ï¼"
          echo "PR æ¨™é¡Œ: ${{ github.event.pull_request.title }}"
          echo "PR ä½œè€…: ${{ github.event.pull_request.user.login }}"
          
      - name: Simulate Deployment to Production
        run: |
          echo "ğŸš€ Simulating deployment to Production environment..."
          sleep 5
          echo "ğŸ‰ Production deployment successful!"
